<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
<link rel="stylesheet" href="../css/styles.css">
<link rel="icon" type="image/png" href="../images/BreakLeam.jpg">
<title>BreakLeam / Отзывы</title>
</head>
<body>

    <body>
        <header>
            
            <div onclick="window.location.href='index.html'"><img class="header-logo" height="100px" src="../images/BreakLeam.jpg" alt="Logo"></div>
            <nav id="navbar" class="nav">
                <div class="nav-links"><a href="../index.html">Главная</a></div>
                <div class="nav-links"><a href="info.html">Информации</a></div>
                <div class="nav-links"><a href="yt.html">Ютуберы</a></div>
                <div class="nav-links"><a href="rules.html">Правила</a></div>
                <div class="nav-links"><a href="otzv.html" class="active">Отзывы</a></div>
            </nav>
    
            <a class="hamburger-menu" onclick="mobileMenu()"><i class="fa fa-bars"></i></a>
        
        </header>
    
        <main>
            <!-- Регистрация -->
<div id="registerBox" class="form-box">
<h2>Регистрация</h2>
<input type="text" id="regUsername" placeholder="Ваше имя"><br>
<input type="password" id="regPassword" placeholder="Пароль"><br>
<input type="password" id="regPassword2" placeholder="Повторите пароль"><br>
<input type="file" id="regAvatar" accept="image/*"><br>
<button onclick="registerUser()">Зарегистрироваться</button>
<p>Уже есть аккаунт? <a href="#" onclick="showLoginBox()">Войти</a></p>
</div>

<!-- Вход -->
<div id="loginBox" class="form-box" style="display:none;">
<h2>Вход</h2>
<input type="text" id="loginUsername" placeholder="Ваше имя"><br>
<input type="password" id="loginPassword" placeholder="Пароль"><br>
<button onclick="loginUser()">Войти</button>
<p>Нет аккаунта? <a href="#" onclick="showRegisterBox()">Зарегистрироваться</a></p>
</div>

<!-- Форма отзывов -->
<div id="reviewBox" class="form-box" style="display:none;">
<h2>Привет, <span id="userDisplay"></span> <img id="userAvatar" src="" width="40" style="border-radius:50%; vertical-align:middle;"></h2>
<button onclick="logoutUser()">Выйти</button><br><br>
<button type="button" onclick="toggleMail()">Письма</button>

<textarea id="reviewInput" placeholder="Ваш отзыв"></textarea>
<button onclick="addReview()">Отправить отзыв</button>
<div id="mailBox" style="display:none; margin-top:15px;">
    <h3>Письма от администраторов</h3>
    
    <div id="mailList"></div>
    
    <div id="adminMailForm" style="margin-top:10px;">
        <input type="text" id="mailTo" placeholder="Кому (имя пользователя)">
        <textarea id="mailInput" placeholder="Текст сообщения"></textarea>
        <button onclick="sendMail()">Отправить письмо</button>
        </div>
    </div>    
</div>

<h2>Отзывы</h2>
<div id="reviewsList"></div>
        </main>
    
        <footer>
            <div class="row">
                <div class="col-5">
                    <div class="centered footer-info">
                        <span>Все права защищены. &copy;</span>
                        <span id="an"> </span>
                    </div>
                </div>
                <div class="col-5 centered">
                    <h3>Наши соцсети</h3>
                    <a href="https://t.me/BreakLeam" target="_blank"><img src="../images/tg.png" alt="Telegram" class="social"></a>
                    <a href="https://t.me/BreakLeam_bot" target="_blank"><img src="../images/tgbot.png" alt="TelegramBot" class="socialb"></a>
                    <a href="https://discord.gg/MYZCfp48" target="_blank"><img src="../images/discord.png" alt="Discord" class="social"></a>
                </div>
            </div>
    
        </footer>
    
        <script src="../js/js.js"></script>
    
    </body>

<div class="container">



<script>
// ---- 1. Список админов и всех пользователей ----
// Администраторов задаём прямо в коде
let predefinedUsers = [
    {name:"Vanovich667_ADM", password:"15fev1215fev12", avatar:"https://static.vecteezy.com/system/resources/thumbnails/019/194/935/small_2x/global-admin-icon-color-outline-vector.jpg", role:"admin"},
    {name:"Lank32123_ADM", password:"Lankadmin12gs2", avatar:"https://static.vecteezy.com/system/resources/thumbnails/019/194/935/small_2x/global-admin-icon-color-outline-vector.jpg", role:"admin"}
];

// ---- 2. Пользователи ----
let users = JSON.parse(localStorage.getItem('users') || "[]");
for(let u of predefinedUsers){
    if(!users.some(user => user.name === u.name)){
        users.push(u);
    }
}
localStorage.setItem('users', JSON.stringify(users));

let currentUser = JSON.parse(localStorage.getItem('currentUser') || "null");

// ---- 3. Плохие слова ----
const bannedWords = ["хуй","Хуй","сука", "Сука", "бля", "Бля", "блять", "Блять", "хуи", "Хуи", "ебать", "Ебать", "уёбише", "Уёбише", "ахуй", "Ахуй", "", "", "", "", "", "", "", "", "", ""];

// ---- 4. Переключение форм ----
function showLoginBox(){
    document.getElementById('registerBox').style.display='none';
    document.getElementById('loginBox').style.display='block';
    document.getElementById('reviewBox').style.display='none';
}
function showRegisterBox(){
    document.getElementById('registerBox').style.display='block';
    document.getElementById('loginBox').style.display='none';
    document.getElementById('reviewBox').style.display='none';
}

// ---- 5. Регистрация ----
function registerUser(){
    const name = document.getElementById('regUsername').value.trim();
    const pass1 = document.getElementById('regPassword').value;
    const pass2 = document.getElementById('regPassword2').value;
    const fileInput = document.getElementById('regAvatar');

    if(!name || !pass1 || !pass2) return alert("Заполните все поля");
    if(pass1 !== pass2) return alert("Пароли не совпадают");
    if(users.some(u => u.name === name)) return alert("Пользователь с таким именем уже существует");
    if(!fileInput.files[0]) return alert("Выберите аватар");

    const reader = new FileReader();
    reader.onload = function(e){
        const avatarBase64 = e.target.result;
        const newUser = {name:name, password:pass1, avatar:avatarBase64, role:"user"};
        users.push(newUser);
        localStorage.setItem('users', JSON.stringify(users));
        currentUser = newUser;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        showReviewBox();
    }
    reader.readAsDataURL(fileInput.files[0]);
}

// ---- 6. Вход ----
function loginUser(){
    const name = document.getElementById('loginUsername').value.trim();
    const pass = document.getElementById('loginPassword').value;

    const user = users.find(u => u.name === name && u.password === pass);
    if(!user) return alert("Неверное имя или пароль");

    currentUser = user;
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    showReviewBox();
}

// ---- 7. Выход ----
function logoutUser(){
    currentUser = null;
    localStorage.removeItem('currentUser');
    showLoginBox();
}

// ---- 8. Показ формы отзывов ----
function showReviewBox(){
    document.getElementById('registerBox').style.display='none';
    document.getElementById('loginBox').style.display='none';
    document.getElementById('reviewBox').style.display='block';
    document.getElementById('userDisplay').innerText = currentUser.name;
    document.getElementById('userAvatar').src = currentUser.avatar;

    document.getElementById('changeAvatarBtn').style.display = currentUser.role === "user" ? "inline-block" : "none";
    showReviews();
}

// ---- 9. Изменение аватара (только user) ----
function changeAvatar(){
    if(currentUser.role !== "user") return;
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = e => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(ev){
            currentUser.avatar = ev.target.result;
            const idx = users.findIndex(u => u.name === currentUser.name);
            users[idx].avatar = currentUser.avatar;
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            document.getElementById('userAvatar').src = currentUser.avatar;
            showReviews();
        }
        reader.readAsDataURL(file);
    }
    input.click();
}

// ---- 10. Добавление отзыва с анти-токсиком ----
function addReview(){
    let text = document.getElementById('reviewInput').value.trim();
    if(!text) return alert("Введите отзыв");

    if(currentUser.role !== "admin"){
        for(let word of bannedWords){
            const re = new RegExp(word, "gi");
            text = text.replace(re, "*".repeat(word.length));
        }
    }

    let reviews = JSON.parse(localStorage.getItem('reviews') || "[]");
    reviews.push({id: Date.now(), name:currentUser.name, avatar:currentUser.avatar, text:text, role:currentUser.role});
    localStorage.setItem('reviews', JSON.stringify(reviews));
    document.getElementById('reviewInput').value='';
    showReviews();
}

// ---- 11. Удаление отзывов ----
function deleteReview(id){
    let reviews = JSON.parse(localStorage.getItem('reviews') || "[]");
    reviews = reviews.filter(r => {
        if(r.id !== id) return true;
        if(r.name === currentUser.name) return false;
        if(currentUser.role === "admin" && r.role === "user") return false;
        return true;
    });
    localStorage.setItem('reviews', JSON.stringify(reviews));
    showReviews();
}

// ---- 12. Показ отзывов ----
function showReviews(){
    const reviews = JSON.parse(localStorage.getItem('reviews') || "[]");
    const div = document.getElementById('reviewsList');
    if(reviews.length === 0){ div.innerHTML="<p>Пока нет отзывов</p>"; return; }

    div.innerHTML = reviews.map(r=>{
        let canDelete = (r.name===currentUser.name) || (currentUser.role==="admin" && r.role==="user");
        return `
        <div class="review">
            <img src="${r.avatar}">
            <b>${r.name}:</b> ${r.text}
            ${canDelete ? `<button class="delete-btn" onclick="deleteReview(${r.id})">Удалить</button>` : ""}
        </div>`;
    }).join('');
}

// ---- 13. Автоматически показываем форму, если пользователь уже вошёл ----
if(currentUser) showReviewBox();

function toggleMail(){
    const box = document.getElementById("mailBox");
    box.style.display = box.style.display === "none" ? "block" : "none";
    showMail();
}

function sendMail(){
    if(currentUser.role !== "admin") return;

    let to = document.getElementById("mailTo").value.trim();
    let text = document.getElementById("mailInput").value.trim();

    if(!to || !text) return alert("Заполни текст и получателя");

    if(!users.some(u => u.name === to)) return alert("Такого пользователя нет");

    let mails = JSON.parse(localStorage.getItem("mails") || "[]");

    mails.push({
        id: Date.now(),
        from: currentUser.name,
        to: to,
        text: text
    });

    localStorage.setItem("mails", JSON.stringify(mails));

    document.getElementById("mailTo").value = "";
    document.getElementById("mailInput").value = "";

    showMail();
}

function showMail(){
    const mails = JSON.parse(localStorage.getItem("mails") || "[]");
    const list = document.getElementById("mailList");

    let visible = [];

    if(currentUser.role === "admin"){
        visible = mails; // админы видят все письма
    } else {
        visible = mails.filter(m => m.to === currentUser.name); // пользователи только свои
    }

    list.innerHTML = ""; // очищаем перед отрисовкой

    if(visible.length === 0){
        list.innerHTML = "<p>Писем нет</p>";
        return;
    }

    for(let m of visible){
        const div = document.createElement("div");
        div.style.background = "#eee";
        div.style.padding = "8px";
        div.style.marginBottom = "6px";
        div.style.borderRadius = "6px";

        // кнопка удалить только если админ и отправитель письма — текущий админ
        let deleteBtn = "";
        if(currentUser.role === "admin" && m.from === currentUser.name){
            deleteBtn = document.createElement("button");
            deleteBtn.textContent = "Удалить";
            deleteBtn.style.background = "red";
            deleteBtn.style.color = "white";
            deleteBtn.style.marginLeft = "10px";
            deleteBtn.onclick = () => deleteMail(m.id);
            div.appendChild(deleteBtn);
        }

        // содержимое письма
        const content = document.createElement("div");
        content.innerHTML = `<b>${m.from} → ${m.to}</b><br>${m.text}`;
        div.insertBefore(content, div.firstChild);

        list.appendChild(div);
    }

    // форма отправки письма только для админов
    document.getElementById("adminMailForm").style.display =
        currentUser.role === "admin" ? "block" : "none";
}


function deleteMail(id){
    let mails = JSON.parse(localStorage.getItem("mails") || "[]");

    // оставляем только письма, где id не совпадает или письмо отправлено другим админом
    mails = mails.filter(m => m.id !== id || m.from !== currentUser.name);

    localStorage.setItem("mails", JSON.stringify(mails));
    showMail();
}


</script>

</div>
</body>
</html>
