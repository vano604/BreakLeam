<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
<link rel="stylesheet" href="../css/styles.css">
<link rel="icon" type="image/png" href="../images/BreakLeam.jpg">
<title>BreakLeam / –û—Ç–∑—ã–≤—ã</title>
</head>
<body>

<header>
    <div onclick="window.location.href='index.html'"><img class="header-logo" height="100px" src="../images/BreakLeam.jpg" alt="Logo"></div>
    <nav id="navbar" class="nav">
        <div class="nav-links"><a href="../index.html">–ì–ª–∞–≤–Ω–∞—è</a></div>
        <div class="nav-links"><a href="info.html">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</a></div>
        <div class="nav-links"><a href="yt.html">–Æ—Ç—É–±–µ—Ä—ã</a></div>
        <div class="nav-links"><a href="rules.html">–ü—Ä–∞–≤–∏–ª–∞</a></div>
        <div class="nav-links"><a href="otzv.html" class="active">–û—Ç–∑—ã–≤—ã</a></div>
    </nav>
    <a class="hamburger-menu" onclick="mobileMenu()"><i class="fa fa-bars"></i></a>
</header>

<main>
<!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
<div id="registerBox" class="form-box">
<h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
<input type="text" id="regUsername" placeholder="–í–∞—à–µ –∏–º—è"><br>
<input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å"><br>
<input type="password" id="regPassword2" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å"><br>
<input type="file" id="regAvatar" accept="image/*"><br>
<button onclick="registerUser()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
<p>–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" onclick="showLoginBox()">–í–æ–π—Ç–∏</a></p>
</div>

<!-- –í—Ö–æ–¥ -->
<div id="loginBox" class="form-box" style="display:none;">
<h2>–í—Ö–æ–¥</h2>
<input type="text" id="loginUsername" placeholder="–í–∞—à–µ –∏–º—è"><br>
<input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å"><br>
<button onclick="loginUser()">–í–æ–π—Ç–∏</button>
<p>–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" onclick="showRegisterBox()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></p>
</div>

<!-- –§–æ—Ä–º–∞ –æ—Ç–∑—ã–≤–æ–≤ -->
<div id="reviewBox" class="form-box" style="display:none;">
<h2>–ü—Ä–∏–≤–µ—Ç, <span id="userDisplay"></span> <img id="userAvatar" src="" width="40" style="border-radius:50%; vertical-align:middle;"></h2>
<button onclick="logoutUser()">–í—ã–π—Ç–∏</button><br><br>
<button type="button" onclick="toggleMail()">–ü–∏—Å—å–º–∞</button><br><br>

<textarea id="reviewInput" placeholder="–í–∞—à –æ—Ç–∑—ã–≤"></textarea><br>
<button onclick="addReview()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>

<div id="mailBox" style="display:none; margin-top:15px;">
    <h3>–ü–∏—Å—å–º–∞</h3>
    <div id="mailList"></div>
    <div id="adminMailForm" style="margin-top:10px;">
        <input type="text" id="mailTo" placeholder="–ö–æ–º—É (–∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)"><br>
        <textarea id="mailInput" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è"></textarea><br>
        <button onclick="sendFirebaseMail()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ</button>
    </div>
</div>
</div>

<h2>–û—Ç–∑—ã–≤—ã</h2>
<div id="reviewsList"></div>

</main>

<footer>
    <div class="row">
        <div class="col-5">
            <div class="centered footer-info">
                <span>–í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã. &copy;</span>
            </div>
        </div>
        <div class="col-5 centered">
            <h3>–ù–∞—à–∏ —Å–æ—Ü—Å–µ—Ç–∏</h3>
            <a href="https://t.me/BreakLeam" target="_blank"><img src="../images/tg.png" alt="Telegram" class="social"></a>
            <a href="https://t.me/BreakLeam_bot" target="_blank"><img src="../images/tgbot.png" alt="TelegramBot" class="socialb"></a>
            <a href="https://discord.gg/MYZCfp48" target="_blank"><img src="../images/discord.png" alt="Discord" class="social"></a>
        </div>
    </div>
</footer>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBDNfOQ8lv2c-8mNhku5MgDck32sLbo7qc",
    authDomain: "breakleam.firebaseapp.com",
    databaseURL: "https://breakleam-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "breakleam",
    storageBucket: "breakleam.firebasestorage.app",
    messagingSenderId: "669261362848",
    appId: "1:669261362848:web:8268b40e00e89f2a56bbc5"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// –ê–¥–º–∏–Ω—ã
let predefinedUsers = [
    {name:"Vanovich667_ADM", password:"15fev1215fev12", avatar:"https://static.vecteezy.com/system/resources/thumbnails/019/194/935/small_2x/global-admin-icon-color-outline-vector.jpg", role:"admin"},
    {name:"Lank32123_ADM", password:"Lankadmin12gs2", avatar:"https://static.vecteezy.com/system/resources/thumbnails/019/194/935/small_2x/global-admin-icon-color-outline-vector.jpg", role:"admin"}
];

// –î–æ–±–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω–æ–≤ –≤ Firebase, –µ—Å–ª–∏ –∏—Ö —Ç–∞–º –Ω–µ—Ç
predefinedUsers.forEach(admin => {
    firebase.database().ref('users').orderByChild('name').equalTo(admin.name).once('value')
    .then(snapshot => {
        if (!snapshot.exists()) {
            firebase.database().ref('users').push(admin);
        }
    });
});

let currentUser = JSON.parse(localStorage.getItem('currentUser') || "null");

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ñ–æ—Ä–º
function showLoginBox(){
    document.getElementById('registerBox').style.display='none';
    document.getElementById('loginBox').style.display='block';
    document.getElementById('reviewBox').style.display='none';
}
function showRegisterBox(){
    document.getElementById('registerBox').style.display='block';
    document.getElementById('loginBox').style.display='none';
    document.getElementById('reviewBox').style.display='none';
}

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
function registerUser(){
    const name=document.getElementById('regUsername').value.trim();
    const pass1=document.getElementById('regPassword').value;
    const pass2=document.getElementById('regPassword2').value;
    const fileInput=document.getElementById('regAvatar');

    if(!name || !pass1 || !pass2) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è");
    if(pass1!==pass2) return alert("–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç");
    if(!fileInput.files[0]) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä");

    const reader = new FileReader();
    reader.onload=function(e){
        const avatarBase64=e.target.result;
        const newUser={name:name,password:pass1,avatar:avatarBase64,role:"user"};

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –≤ Firebase
        firebase.database().ref('users').orderByChild('name').equalTo(name).once('value').then(snapshot=>{
            if(snapshot.exists()) return alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç");

            firebase.database().ref('users').push(newUser).then(()=>{
                currentUser=newUser;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showReviewBox();
            }).catch(err=>alert("–û—à–∏–±–∫–∞: "+err.message));
        });
    }
    reader.readAsDataURL(fileInput.files[0]);
}

// –í—Ö–æ–¥
function loginUser(){
    const name=document.getElementById('loginUsername').value.trim();
    const pass=document.getElementById('loginPassword').value;

    firebase.database().ref('users').once('value').then(snapshot=>{
        const usersDb = snapshot.val() || {};
        const user = Object.values(usersDb).find(u=>u.name===name && u.password===pass);
        if(!user) return alert("–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å");

        currentUser = user;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        showReviewBox();
    }).catch(err=>alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: "+err.message));
}

// –í—ã—Ö–æ–¥
function logoutUser(){
    currentUser=null;
    localStorage.removeItem('currentUser');
    showLoginBox();
}

// –§–æ—Ä–º–∞ –æ—Ç–∑—ã–≤–æ–≤
function showReviewBox(){
    document.getElementById('registerBox').style.display='none';
    document.getElementById('loginBox').style.display='none';
    document.getElementById('reviewBox').style.display='block';
    document.getElementById('userDisplay').innerText=currentUser.name;
    document.getElementById('userAvatar').src=currentUser.avatar;
    showReviews();
    showFirebaseMail();
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞
function addReview() {
    if (!currentUser) return alert("–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã"); // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

    const input = document.getElementById("reviewInput");
    const text = input.value.trim();

    if (!text) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞"); // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—Å—Ç–∞

    // 3. –°–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç –æ—Ç–∑—ã–≤–∞
    const review = {
        name: currentUser.name,
        avatar: currentUser.avatar,
        text: text,
        role: currentUser.role, // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–æ–ª—å
        likes: [],
        dislikes: [],
        timestamp: Date.now()
    };

    // 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–∑—ã–≤ –≤ Firebase
    const newReviewKey = firebase.database().ref().child('reviews').push().key;
    const updates = {};
    updates['/reviews/' + newReviewKey] = review;

    firebase.database().ref().update(updates)
        .then(() => {
            // 5. –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            input.value = "";
            showReviews();
        })
        .catch(err => alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –æ—Ç–∑—ã–≤–∞: " + err.message));
}


// –ü–æ–∫–∞–∑ –æ—Ç–∑—ã–≤–æ–≤
function showReviews(){
    const div = document.getElementById("reviewsList");
    div.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤...";

    firebase.database().ref('reviews').once('value').then(snapshot=>{
        const reviews = snapshot.val();
        div.innerHTML = "";
        if(!reviews){ div.innerHTML="<p>–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</p>"; return; }

        const reviewsArr = Object.keys(reviews).map(k=>({id:k,...reviews[k]}));
        reviewsArr.sort((a,b)=>b.timestamp-a.timestamp);

        reviewsArr.forEach(r=>{
            r.likes = r.likes||[];
            r.dislikes = r.dislikes||[];
            const liked = r.likes.includes(currentUser.name);
            const disliked = r.dislikes.includes(currentUser.name);
            const canDelete = currentUser.name===r.name || (currentUser.role==="admin" && r.role==="user");

            const reviewDiv=document.createElement("div");
            reviewDiv.className="review";
            reviewDiv.style.borderBottom="1px solid #ccc";
            reviewDiv.style.padding="10px 0";

            reviewDiv.innerHTML=`
                <div style="display:flex; align-items:flex-start; gap:10px;">
                    <img src="${r.avatar}" width="40" height="40" style="border-radius:50%;">
                    <div style="flex:1; word-break: break-word;">
                        <b>${r.name}:</b> ${r.text}
                    </div>
                </div>
                <div style="margin-top:5px; display:flex; gap:10px; align-items:center;">
                    <button onclick="toggleFirebaseLike('${r.id}','like')" style="background:${liked?'#8f8':'#eee'}">üëç ${r.likes.length}</button>
                    <button onclick="toggleFirebaseLike('${r.id}','dislike')" style="background:${disliked?'#f88':'#eee'}">üëé ${r.dislikes.length}</button>
                    ${canDelete? `<button onclick="deleteFirebaseReview('${r.id}')" style="background:red;color:white;">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                </div>
            `;
            div.appendChild(reviewDiv);
        });
    }).catch(err=>{div.innerHTML="–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–∑—ã–≤–æ–≤: "+err.message;});
}

// –õ–∞–π–∫–∏ / –î–∏–∑–ª–∞–π–∫–∏
function toggleFirebaseLike(key,type){
    const reviewRef = firebase.database().ref('reviews/'+key);
    reviewRef.once('value').then(snapshot=>{
        const r=snapshot.val();
        if(!r) return;

        r.likes = r.likes||[];
        r.dislikes = r.dislikes||[];

        if(type==='like'){
            r.dislikes = r.dislikes.filter(u=>u!==currentUser.name);
            if(r.likes.includes(currentUser.name)) r.likes = r.likes.filter(u=>u!==currentUser.name);
            else r.likes.push(currentUser.name);
        }

        if(type==='dislike'){
            r.likes = r.likes.filter(u=>u!==currentUser.name);
            if(r.dislikes.includes(currentUser.name)) r.dislikes = r.dislikes.filter(u=>u!==currentUser.name);
            else r.dislikes.push(currentUser.name);
        }

        reviewRef.update({likes:r.likes, dislikes:r.dislikes}).then(()=>showReviews());
    });
}

// –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞
function deleteFirebaseReview(key){
    firebase.database().ref('reviews/'+key).remove().then(()=>showReviews()).catch(err=>alert("–û—à–∏–±–∫–∞: "+err.message));
}

// –ü–∏—Å—å–º–∞
function sendFirebaseMail(){
    if(currentUser.role!=="admin") return alert("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–∏—Å—å–º–∞");

    const to=document.getElementById("mailTo").value.trim();
    const text=document.getElementById("mailInput").value.trim();
    if(!to||!text) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è");

    firebase.database().ref('users').once('value').then(snapshot=>{
        const usersDb=snapshot.val()||{};
        if(!Object.values(usersDb).some(u=>u.name===to)) return alert("–¢–∞–∫–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç");

        const newKey=firebase.database().ref().child('mails').push().key;
        const mail = {id:newKey, from:currentUser.name, to:to, text:text, timestamp:Date.now()};
        const updates = {}; updates['/mails/'+newKey]=mail;

        firebase.database().ref().update(updates).then(()=>{
            document.getElementById("mailTo").value=""; document.getElementById("mailInput").value="";
            showFirebaseMail();
        }).catch(err=>alert("–û—à–∏–±–∫–∞: "+err.message));
    });
}

function showFirebaseMail(){
    const list=document.getElementById("mailList");
    list.innerHTML="–ó–∞–≥—Ä—É–∑–∫–∞ –ø–∏—Å–µ–º...";

    firebase.database().ref('mails').once('value').then(snapshot=>{
        const mails=snapshot.val(); list.innerHTML="";
        if(!mails){ list.innerHTML="<p>–ü–∏—Å–µ–º –Ω–µ—Ç</p>"; return; }

        const mailsArr=Object.keys(mails).map(k=>({id:k,...mails[k]}));
        mailsArr.sort((a,b)=>b.timestamp-a.timestamp);

        mailsArr.forEach(m=>{
            if(currentUser.role!=="admin" && m.to!==currentUser.name) return;

            const div=document.createElement("div");
            div.style.background="#eee"; div.style.padding="8px"; div.style.marginBottom="6px"; div.style.borderRadius="6px";

            if(currentUser.role==="admin" && m.from===currentUser.name){
                const delBtn=document.createElement("button");
                delBtn.textContent="–£–¥–∞–ª–∏—Ç—å"; delBtn.style.background="red"; delBtn.style.color="white"; delBtn.style.marginLeft="10px";
                delBtn.onclick=()=>deleteFirebaseMail(m.id); div.appendChild(delBtn);
            }

            const content=document.createElement("div");
            content.innerHTML=`<b>${m.from} ‚Üí ${m.to}</b><br>${m.text}`; div.insertBefore(content, div.firstChild);
            list.appendChild(div);
        });
    });
}

function deleteFirebaseMail(id){
    firebase.database().ref('mails/'+id).remove().then(()=>showFirebaseMail()).catch(err=>alert("–û—à–∏–±–∫–∞: "+err.message));
}

function toggleMail(){
    const mailBox=document.getElementById("mailBox");
    if(mailBox.style.display==="none" || mailBox.style.display==="") { mailBox.style.display="block"; showFirebaseMail(); }
    else mailBox.style.display="none";
}

// –ê–≤—Ç–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
window.onload=function(){
    if(currentUser) showReviewBox();
    else showLoginBox();
};
</script>

</body>
</html>
